id: org.freedesktop.Sdk.Extension.openjdk8
branch: '24.08'
runtime: org.freedesktop.Sdk
runtime-version: '24.08'
build-extension: true
sdk: org.freedesktop.Sdk
separate-locales: false
cleanup:
  - /share/info
  - /share/man
build-options:
  no-debuginfo: true
  strip: true
  prefix: /usr/lib/sdk/openjdk8
  env:
    V: '1'
modules:
  - name: bootstrap-java
    cleanup:
      - '*'
    buildsystem: simple
    sources:
      - type: archive
        dest: bootstrap-java
        only-arches:
          - aarch64
        url: https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u422-b05/OpenJDK8U-jdk_aarch64_linux_hotspot_8u422b05.tar.gz
        dest-filename: java-openjdk.tar.gz
        sha256: af98a839ec238106078bd360af9e405dc6665c05ee837178ed13b92193681923
        x-checker-data:
          type: json
          url: https://api.github.com/repos/adoptium/temurin8-binaries/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name | startswith("OpenJDK8U-jdk_aarch64_linux_hotspot_") and endswith(".tar.gz")).browser_download_url
      - type: archive
        dest: bootstrap-java
        only-arches:
          - x86_64
        url: https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u422-b05/OpenJDK8U-jdk_x64_linux_hotspot_8u422b05.tar.gz
        dest-filename: java-openjdk.tar.gz
        sha256: 4c6056f6167fae73ace7c3080b78940be5c87d54f5b08894b3517eed1cbb2c06
        x-checker-data:
          type: json
          url: https://api.github.com/repos/adoptium/temurin8-binaries/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name | startswith("OpenJDK8U-jdk_x64_linux_hotspot_") and endswith(".tar.gz")).browser_download_url
    build-commands:
      - mv bootstrap-java $FLATPAK_DEST/
  - name: java
    buildsystem: autotools
    no-parallel-make: true
    config-opts:
      - --with-boot-jdk=/usr/lib/sdk/openjdk8/bootstrap-java
      - --with-jvm-variants=server
      - --with-debug-level=release
      - --with-native-debug-symbols=internal
      - --enable-unlimited-crypto
      - --with-zlib=system
      - --with-giflib=system
      - --with-extra-cxxflags=-O2 -g -Wno-error -std=gnu++98 -fno-delete-null-pointer-checks -fno-lifetime-dse -fcommon
      - --with-extra-cflags=-O2 -g -fstack-protector-strong -Wno-error -fno-delete-null-pointer-checks -fno-lifetime-dse -fcommon
      - --with-extra-ldflags=-Wl,-z,relro -Wl,-z,now
      - --with-milestone=fcs
    make-args:
      - JAVAC_FLAGS=-g
      - LOG=trace
      - WARNINGS_ARE_ERRORS=-Wno-error
      - CFLAGS_WARNINGS_ARE_ERRORS=-Wno-error
      - images
    sources:
      - type: git
        url: https://github.com/adoptium/jdk8u.git
        tag: jdk8u422-b05
        commit: 18b3ca58d72881d3b6a89c6f299e26635fd149c4
        x-checker-data:
          type: json
          url: https://api.github.com/repos/adoptium/temurin8-binaries/releases/latest
          is-main-source: true
          tag-query: .tag_name
      - type: patch
        paths:
          - patches/0001-Fix-Wint-conversion.patch
          - patches/0002-Fix-Wincompatible-pointer-types.patch
      - type: shell
        commands:
          - chmod a+x configure
          - git describe --match "jdk8u*-b*" HEAD | sed -e 's/jdk8u[[:digit:]]\+-\(b[[:digit:]]\+\)/JDK_BUILD_NUMBER=\1/' >> common/autoconf/version-numbers
  - name: maven
    buildsystem: simple
    cleanup:
      - '*.cmd'
    sources:
      - type: file
        url: http://archive.apache.org/dist/maven/maven-3/3.9.9/binaries/apache-maven-3.9.9-bin.tar.gz
        dest-filename: apache-maven-bin.tar.gz
        sha512: a555254d6b53d267965a3404ecb14e53c3827c09c3b94b5678835887ab404556bfaf78dcfe03ba76fa2508649dca8531c74bca4d5846513522404d48e8c4ac8b
        x-checker-data:
          type: anitya
          project-id: 1894
          stable-only: true
          is-main-source: false
          url-template: http://archive.apache.org/dist/maven/maven-3/$version/binaries/apache-maven-$version-bin.tar.gz
          versions:
            <: 4.0.0
    build-commands:
      - mkdir -p $FLATPAK_DEST/maven
      - tar xf apache-maven-bin.tar.gz --strip-components=1 --exclude=jansi-native --directory=$FLATPAK_DEST/maven
      - ln -s $FLATPAK_DEST/maven/bin/mvn $FLATPAK_DEST/maven/bin/mvnDebug $FLATPAK_DEST/bin
  - name: scripts
    buildsystem: simple
    sources:
      - type: script
        commands:
          - mkdir -p /app/jre
          - cd /usr/lib/sdk/openjdk8/jvm/java-8-openjdk
          - cp -ra * /app/jre
          - rm -rf /app/jre/src.zip /app/jre/include /app/jre/demo /app/jre/sample
        dest-filename: install.sh
      - type: script
        commands:
          - mkdir -p /app/jdk
          - cd /usr/lib/sdk/openjdk8/jvm/java-8-openjdk
          - cp -ra * /app/jdk
        dest-filename: installjdk.sh
      - type: script
        commands:
          - export JAVA_HOME=/usr/lib/sdk/openjdk8/jvm/java-8-openjdk
          - export PATH=$PATH:/usr/lib/sdk/openjdk8/bin
        dest-filename: enable.sh
    build-commands:
      - (cd /usr/lib/sdk/openjdk8/jvm && ln -s openjdk-1.8.0* java-8-openjdk)
      - cp enable.sh install.sh installjdk.sh /usr/lib/sdk/openjdk8/
  - name: appdata
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/appdata
      - cp org.freedesktop.Sdk.Extension.openjdk8.appdata.xml ${FLATPAK_DEST}/share/appdata
    sources:
      - type: file
        path: org.freedesktop.Sdk.Extension.openjdk8.appdata.xml
